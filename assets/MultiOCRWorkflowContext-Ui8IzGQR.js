var X=Object.defineProperty;var Z=(u,t,s)=>t in u?X(u,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):u[t]=s;var x=(u,t,s)=>Z(u,typeof t!="symbol"?t+"":t,s);import{a as i,p as b}from"./chunk-B7RQU5TL-mf8dp6A9.js";import{createClient as k}from"./index-DOzBNQ5J.js";import{M as T}from"./mathpixService-DdEer5QH.js";class ee{constructor(){x(this,"config",null);x(this,"client",null);this.loadConfigFromLocalStorage()}loadConfigFromLocalStorage(){if(typeof window>"u"||typeof localStorage>"u")return;const t={supabaseUrl:localStorage.getItem("supabase.url")||"",supabaseAnonKey:localStorage.getItem("supabase.anonKey")||"",bucketName:localStorage.getItem("supabase.bucket")||"",basePath:localStorage.getItem("supabase.basePath")||""};this.isConfigValid(t)&&(this.config=t,this.client=k(t.supabaseUrl,t.supabaseAnonKey))}isConfigValid(t){return t.supabaseUrl.trim().length>0&&t.supabaseAnonKey.trim().length>0&&t.bucketName.trim().length>0}isConfigured(){return this.config!==null&&this.isConfigValid(this.config)}async uploadPhotoAsync(t){if(!this.isConfigured())return{success:!1,error:"Supabase no está configurado. Ve a la página de configuración."};try{const s=new Date,g=h=>String(h).padStart(2,"0"),w=`${s.getFullYear()}${g(s.getMonth()+1)}${g(s.getDate())}-${g(s.getHours())}${g(s.getMinutes())}${g(s.getSeconds())}-${String(s.getMilliseconds()).padStart(3,"0")}`,m=(t.name.split(".").pop()||"").toLowerCase(),d=m&&m.length<=6?m:"jpg",O=(this.config.basePath||"").trim(),p=O?`${O}-${w}.${d}`:`${w}.${d}`,{error:S}=await this.client.storage.from(this.config.bucketName).upload(p,t,{cacheControl:"3600",upsert:!1,contentType:t.type||void 0});return S?{success:!1,error:`Error al subir: ${S.message}`}:{success:!0,path:p}}catch(s){return{success:!1,error:`Error: ${s instanceof Error?s.message:String(s)}`}}}async uploadMultiplePhotosAsync(t){const s=t.map(g=>this.uploadPhotoAsync(g));return Promise.all(s)}refreshConfig(){typeof window>"u"||typeof localStorage>"u"||this.loadConfigFromLocalStorage()}}const oe=new ee,A={questionCompilerAgentId:"",responseAgentIds:[],maxImages:3,enableTTS:!1,directAgentsIds:[],selectedPromptId:"",immediateOCR:!1},F=i.createContext(void 0);function ce({children:u}){const[t,s]=i.useState(A),[g,w]=i.useState(!0),[m,d]=i.useState([]),[O,p]=i.useState([]),[S,h]=i.useState(!1),[D,M]=i.useState(""),[N,v]=i.useState(null),[K,W]=i.useState({}),[U,P]=i.useState({});i.useEffect(()=>{try{const o=localStorage.getItem("multi-ocr-workflow-config");if(o){const r=JSON.parse(o);s(e=>({...A,...r}))}}catch(o){console.error("Error loading Multi-OCR Workflow config from localStorage:",o)}finally{w(!1)}},[]);const j=o=>{s(r=>({...r,...o}))},q=o=>{s(o);try{localStorage.setItem("multi-ocr-workflow-config",JSON.stringify(o))}catch(r){console.error("Error saving Multi-OCR Workflow config to localStorage:",r)}},z=()=>{s(A);try{localStorage.removeItem("multi-ocr-workflow-config")}catch(o){console.error("Error removing Multi-OCR Workflow config from localStorage:",o)}},V=o=>{const r=t.maxImages||3,e=m.length,a=Math.max(0,r-e),l=o.slice(0,a),y=l.map(c=>({id:Date.now().toString()+Math.random().toString(36).substr(2,9),file:c,name:c.name,size:c.size,status:"pending"}));d(c=>[...c,...y]),l.forEach(c=>{oe.uploadPhotoAsync(c).then(f=>{f.success?console.log(`✓ Foto subida a Supabase: ${f.path}`):console.warn(`✗ Error al subir foto a Supabase: ${f.error}`)}).catch(f=>{console.error("✗ Error al subir foto a Supabase:",f)})})},_=o=>{d(r=>r.filter(e=>e.id!==o))},I=()=>{d([])},R=(o,r,e)=>{d(a=>a.map(l=>l.id===o?{...l,status:r,...e&&{ocrResult:e}}:l))},J=()=>{p([{id:"ocr-processing",name:"Procesamiento OCR de imágenes",status:"pending"},{id:"ocr-compilation",name:"Compilación de resultados OCR",status:"pending"},{id:"question-compiler",name:"Procesamiento con agente compilador",status:"pending"},{id:"response-agents",name:"Procesamiento con agentes de respuesta",status:"pending"}])},G=(o,r)=>{p(e=>e.map(a=>a.id===o?{...a,...r}:a))},H=(o,r)=>{W(e=>({...e,[o]:r}))},Q=(o,r)=>{P(e=>({...e,[o]:r}))},E=()=>{M(""),v(null),W({}),P({})},Y=()=>{h(!1),p(o=>o.map(r=>r.status==="processing"?{...r,status:"error",error:"Cancelado por el usuario"}:r))},$=()=>{I()},B={config:t,updateConfig:j,saveConfig:q,resetToDefaults:z,isLoading:g,images:m,addImages:V,removeImage:_,clearImages:I,updateImageStatus:R,workflowSteps:O,updateWorkflowStep:G,initializeWorkflowSteps:J,resetWorkflow:()=>{$()},compiledOCRText:D,setCompiledOCRText:M,questionCompilerResult:N,setQuestionCompilerResult:v,responseAgentsResults:K,setResponseAgentResult:H,directAgentsResults:U,setDirectAgentResult:Q,clearResults:E,isRunning:S,setIsRunning:h,cancelWorkflow:Y,resetImages:$,resetAll:()=>{p([]),I(),E()},resetWorkflowCompletely:()=>{S&&h(!1),p([]),I(),E(),console.log("🔄 Workflow completamente reiniciado")},processImageOCRImmediate:async(o,r,e)=>{var l,y,c,f,L;console.log("🔍 processImageOCRImmediate llamado con:",{imageId:o,ocrOptions:r,hasCallbacks:!!e});const a=m.find(n=>n.id===o);if(!a){console.error("Imagen no encontrada para OCR inmediato:",o),console.log("Imágenes disponibles:",m.map(n=>({id:n.id,name:n.name,status:n.status})));return}try{console.log("🚀 Iniciando OCR inmediato para imagen:",a.name),R(o,"processing"),(l=e==null?void 0:e.onImageOCRStart)==null||l.call(e,o),console.log("📡 Enviando request a Mathpix...");const n=await T.processImage(a.file,r);if(console.log("📡 Respuesta de Mathpix recibida:",n),n.error)console.error("Error en OCR inmediato:",n.error),R(o,"error",{status:0,data:null,error:n.error}),(y=e==null?void 0:e.onImageOCRError)==null||y.call(e,o,n.error);else if(console.log("✅ OCR inmediato completado para imagen:",a.name),R(o,"completed",n),(c=e==null?void 0:e.onImageOCRComplete)==null||c.call(e,o,n),n.data){const C=T.extractConfidence(n.data);C!==null&&(console.log("🎯 Confianza extraída:",C),(f=e==null?void 0:e.onConfidenceAvailable)==null||f.call(e,o,C))}}catch(n){const C=n instanceof Error?n.message:"Error desconocido";console.error("Error en OCR inmediato:",C),R(o,"error",{status:0,data:null,error:C}),(L=e==null?void 0:e.onImageOCRError)==null||L.call(e,o,C)}}};return b.jsx(F.Provider,{value:B,children:u})}function le(){const u=i.useContext(F);if(u===void 0)throw new Error("useMultiOCRWorkflow must be used within a MultiOCRWorkflowProvider");return u}export{ce as M,oe as s,le as u};
